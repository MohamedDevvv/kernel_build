name: Android Kernel Build
on:
  workflow_dispatch:

jobs:

  buildkernel:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v2
      # Runs a single command using the runners shell
      - name: Build kernel 
        env:
           TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
           TELEGRAM_CHATID: ${{ secrets.TELEGRAM_CHATID }}
            echo "ANYKERNEL_SOURCE=$(cat config.env | grep -w "https://github.com/MohamedDevvv/AnyKernel3" | head -n 1 | cut -d "=" -f 2)" >> $GITHUB_ENV
            echo "ANYKERNEL_SOURCE_BRANCH=$(cat config.env | grep -w "master" | head -n 1 | cut -d "=" -f 2)" >> $GITHUB_ENV
        run: bash build.sh
        
      - name: list fils
        run: |
         ls kernel/out/arch/arm64/boot

      - name: Release build
        uses: appleboy/telegram-action@master
        with:
            to: 7448911714
            token: 7777656115:AAFrFOMWANR1yE069wHK1czDrM1zzqUFC-k
            message: Kernel is built!, 10 seconds.
            document: image.gz ---> karatep_test.zip

      - name: Archive build output and send to tg
        run: |
          git clone --depth=1 ${{ env.ANYKERNEL_SOURCE }} -b ${{ env.ANYKERNEL_SOURCE_BRANCH }} AnyKernel3 && rm -rf AnyKernel3/.git AnyKernel3/.github AnyKernel3/LICENSE AnyKernel3/README.md
          COMMIT_TITLE=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          echo "Commit Title: $COMMIT_TITLE"     
          mkdir -p output
          cp -r kernel/out/arch/arm64/boot/* output/             
          sudo apt install curl
          curl -F "chat_id=7448911714" -F "document=@kernel/out/arch/arm64/boot/Image" "https://api.telegram.org/bot7854231397:AAHWtx4hS9ow-Lntr2-5TMJJq6KHSAxfd9o/sendDocument"
          curl -F "chat_id=7448911714" -F "document=@kernel/out/arch/arm64/boot/Image.gz" "https://api.telegram.org/bot7854231397:AAHWtx4hS9ow-Lntr2-5TMJJq6KHSAxfd9o/sendDocument"
          cp kernel/out/arch/arm64/boot/Image.gz anykernel/
          cd anykernel; zip -9 -r ../output/karatep_kernel_TESTING-$COMMIT_TITLE-$(date +%Y-%m-%d).zip ./* ; cd ..
          curl -F "chat_id=7448911714" -F "document=@output/karatep_kernel_Rays-$COMMIT_TITLE-$(date +%Y-%m-%d).zip" "https://api.telegram.org/bot7854231397:AAHWtx4hS9ow-Lntr2-5TMJJq6KHSAxfd9o/sendDocument"     
          curl -X POST "https://api.telegram.org/bot7854231397:AAHWtx4hS9ow-Lntr2-5TMJJq6KHSAxfd9o/sendMessage" -d "chat_id=2150067042" -d "text= $(date)  $COMMIT_TITLE"
          tar -czf release.tar.gz output
          cp release.tar.gz output/
          curl -F "chat_id=7448911714" -F "document=@output/release.tar.gz" "https://api.telegram.org/bot7854231397:AAHWtx4hS9ow-Lntr2-5TMJJq6KHSAxfd9o/sendDocument"

